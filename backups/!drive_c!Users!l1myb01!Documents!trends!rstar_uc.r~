## UC model for inflation: RW + ARMA(p,q) + noise
rm(list=ls())
graphics.off()
source("R/fns.R")
source("R/uc_fns.R")  # est.uc, getSigNu2, kalman.uc, getSSMatrices.uc
set.seed(616)

## choose this
simFlag <- FALSE
p <- 4 # AR
q <- 1
## fixed <- c(NA, 0, 0, NA)
## fixed <- c(NA, 0, 0, 0, 0, NA, 0, 0, 0, 0, 0, NA, NA)  # MA
## TAU <- NA #.01  #

if (simFlag) {
    ## simulate inflation data
    T <- 500
    dgp <- list(phi = c(1.3, -0.6),
                theta = c(-0.3, 0.2), #rep(0, 10), -.6, 0.4),
                sigv2 = 1,
                tau = 0.05,
                sig2 = 0.1)
    dgp$signu2 <- getSigNu2(dgp$tau, dgp$theta, dgp$phi, dgp$sigv2)
    cat("DGP roots:\n")
    ARroots <- abs(polyroot(c(1, -dgp$phi)))
    cat("abs(AR roots):", ARroots, "\n")
    MAroots <- abs(polyroot(c(1, dgp$theta)))
    cat("abs(MA roots):", MAroots, "\n")
    if (any(ARroots<=1.001) | any(MAroots<=1.001))
        stop()
    dgp <- c(dgp, getSSMatrices.uc(dgp))
    df <- simData.uc(dgp, T)
    df$Date <- seq(as.Date('1960-01-01'), by = 'months', length = T)
} else {
    ##df <- getCoreCPIq()
    ## df <- getCoreCPIm(change="yoy", sa=TRUE)
    ##df <- getCoreCPIm(change="mom", sa=TRUE)
    df <- getGDPDef()
    ## df <- subset(df, Date < "2012-07-01")  # Clark-Doh
    cat("Date range:", format(range(df$Date)), "\n")
}

if (simFlag) {
    pars <- est.uc(df$pi, p, q, TAU=NA, SIG2=NA, nstarts=10, dgp=dgp)
} else {
    pars <- est.uc(df$pi, p, q, TAU=NA, SIG2=NA, nstarts=10)
}

kf <- kalman.uc(pars, df$pi)
df$pistar <- kf$att[1,]

## plot
plot(df$Date, df$pi, col="blue", type="l", lwd=1, xlab="Year", ylab="Annualized Percent")
lines(df$Date, df$pistar, col="black", lwd=2)
lines(df$Date, getEWMA(df$pi), col="red", lwd=2)
if (simFlag) {
    lines(df$Date, df$trend, col="green", lwd=2)
    legend("topright", c("inflation", "filtered trend", "EWMA", "true trend"), col=c("blue", "black", "red", "green"), lwd=c(1,2,2,2))
} else {
    legend("topright", c("inflation", "filtered trend", "EWMA"), col=c("blue", "black", "red"), lwd=c(1,2,2))
}

## look at moments
cat("variance of inflation:", var(df$pi), "\n")
cat("variance of EWMA trend:", var(getEWMA(df$pi)), "\n")
cat("variance of EWMA gap:", var(df$pi - getEWMA(df$pi)), "\n")
cat("variance of filtered trend:", var(df$pistar), "\n")
cat("variance of filtered gap:", var(df$pi - df$pistar), "\n")

## model diagnostics
vt <- as.numeric(kf$vt)
ft <- as.numeric(kf$Ft)
mytsdiag(vt, 20)
Box.test(vt, 20, "Ljung", length(gamma)+1)

cat("SE =", sd(vt), "\n")
cat("sqrt(f_T) =", sqrt(tail(ft, 1)), "\n")

## simulate data
M <- 1000
statsData <- getPiStats(df)
stats <- matrix(NA, M, length(statsData))
T <- nrow(df)
cat("# Simulating samples: T =", T, ", M =", M, "...\n")
pars <- c(pars, getSSMatrices.uc(pars))
for (i in 1:M) {
    if (i %% 200==0) cat("Replication ", i, "\n")
    simDF <- simData.uc(pars, T)
    stats[i,] <- getPiStats(simDF)
}
printTblStats(statsData, stats)

## compare population ACFs to ARIMA
## ARIMA
order <- c(2,1,13)  ## even better !
arima.fixed <- c(rep(NA, order[1]), NA, rep(0, 10), NA, NA)
print(arima.fit <- arima(df$pi, order, fixed=arima.fixed))
sim <- arima.sim(n=100000, list(order = order, ar = arima.fit$model$phi, ma = arima.fit$model$theta[1:order[3]]), sd = sqrt(arima.fit$sigma2))

simDF <- simData.uc(pars, 100000)

rhos.data <- acf(diff(df$pi), lag=20, plot=FALSE)
rhos.model <- acf(diff(simDF$pi), lag=20, plot=FALSE)$acf[,,1]
rhos.arima <- acf(diff(sim[-1]), lag=20, plot=FALSE)$acf[,,1]
stats:::plot.acf(rhos.data, ylim=range(c(rhos.model, rhos.arima)))
lines((0:20), rhos.model)
lines((0:20), rhos.arima, lwd=2, col="blue")
legend("topright", c("UC model", "ARIMA model"), lwd=c(1,2), col=c("black", "blue"))
