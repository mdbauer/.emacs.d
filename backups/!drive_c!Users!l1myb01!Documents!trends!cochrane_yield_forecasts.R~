## show level/spread dichotomy documented by Cochrane (RSS comment, CP (08))
## different specification but same principle as in Cochrane
## - PCs instead of 5 forward rates
## - quarterly VAR instead of annual VAR in monthly observations

rm(list=ls())
source("R/trends_fns.r")
df <- loadData()
df <- df[df$yyyymm < 200700,]

## yields and PCs
Y <- data.matrix(df[,attr(df, "yield.cols")[3:17]])
T <- nrow(Y)
Ydem <- sweep(Y, 2, colMeans(Y))
rval <- eigen(cov(Ydem))
W <- rval$vectors[,1:3]
P <- Ydem %*% W
N <- 15

## ## VAR(1)
## ydat <- P[2:T,]
## xdat <- P[1:(T-1),]
## B <- t(ydat)%*%xdat%*%solve(t(xdat)%*%xdat)
## b <- matrix(NA, 3, N)
## B2 <- B
## for (i in 2:(N*4)) {
##     B2 <- B %*% B2
##     if (i%%4==0)
##         b[,i/4] <- W[1,] %*% B2
## }
## Ey_lev <- cbind(Y[,1], P %*% b + mean(Y[,1]))

## annual VAR like Cochrane
ydat <- P[5:T,]
xdat <- P[1:(T-4),]
B <- t(ydat)%*%xdat%*%solve(t(xdat)%*%xdat)
b <- matrix(NA, 3, N)
b[,1] <- W[1,] %*% B
for (i in 2:N) {
    B <- B %*% B
    b[,i] <- W[1,] %*% B
}
Ey_lev <- cbind(Y[,1], P %*% b + mean(Y[,1]))
## these lead to even more stable long-horizon forecasts than quarterly VAR
print(apply(Ey_lev, 2, sd))

## ## next: common trend like Cochrane -- VAR for spreads
## ## instead of 1y yield and 2-5y forward rates I use: 1y yield and 2,5,10y forward rates
## F <- cbind(2*Y[,2]-Y[,1], 5*Y[,5]-4*Y[,4], 10*Y[,10]-9*Y[,9])
## xdat <- F - Y[,1] %*% matrix(1, 1, ncol(F))
## xdat <- xdat[1:(T-4),]
## xdat <- sweep(xdat, 2, colMeans(xdat))
## ydat <- cbind(Y[5:T,1], F[5:T,]) - Y[1:(T-4),1] %*% matrix(1, 1, ncol(F)+1)
## ydat <- sweep(ydat, 2, colMeans(ydat))
## Bdiff <- t(ydat)%*%xdat%*%solve(t(xdat)%*%xdat)
## B <- cbind(1-rowSums(Bdiff), Bdiff)
## b <- matrix(NA, 1+ncol(F), N)
## b[,1] <- B[1,]
## for (i in 2:N) {
##     B <- B %*% B
##     b[,i] <- B[1,]
## }
## X <- cbind(Y[,1], F)
## X <- sweep(X, 2, colMeans(X))
## Ey_diff <- cbind(Y[,1], X %*% b + mean(Y[,1]))

## par(mfcol=c(1,2), mar=c(4,3,2,1))
matplot(df$date, Ey_lev, type="l", xaxt="n")
axis.Date(1, at=seq(as.Date("1975/1/1"), max(df$date), by="5 year"), format = "%Y")
## matplot(df$date, Ey_diff, type="l", xaxt="n")
## axis.Date(1, at=seq(as.Date("1975/1/1"), max(df$date), by="5 year"), format = "%Y")


## then: common trend is r*+pi*
