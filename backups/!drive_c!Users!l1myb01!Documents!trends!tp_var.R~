## term premium estimates -- stationary VAR vs. shifting-endpoint (trendy) VAR

rm(list=ls())
graphics.off()
source("R/trends_fns.r")
df <- loadData()
df <- df[df$yyyymm < 200800,]
cat("Date range:", range(df$yyyymm), "\n")
df$istar <- df$pistar.ptr + df$rstar.mean
N <- 15
Y <- data.matrix(df[,attr(df, "yield.cols")[3:(2+N)]])
T <- nrow(Y)

## annual VAR, stationary, in yield PCs (similar to Cochrane's level specification)
W <- eigen(cov(Y))$vectors[,1:3]
P <- Y %*% W
ydat <- P[5:T,]
ydat <- sweep(ydat, 2, colMeans(ydat, na.rm=TRUE))
xdat <- P[1:(T-4),]  ## one-year lag -- annual VAR in quarterly observations
xdat <- sweep(xdat, 2, colMeans(xdat, na.rm=TRUE))
B <- t(ydat)%*%xdat%*%solve(t(xdat)%*%xdat)
b <- matrix(NA, 3, N)
B2 <- B
b[,1] <- W[1,] %*% B2
for (i in 2:N) {
    B2 <- B %*% B2
    b[,i] <- W[1,] %*% B2
}
Pbar <- colMeans(P)
Pdem <- sweep(P, 2, Pbar)
Ey_lev <- cbind(Y[,1], Pdem %*% b + as.numeric(W[1,] %*% colMeans(P)))
## print(tail(Ey_lev[,1:5]))
## print(apply(Ey_lev, 2, sd))
## alternatives:
## - quarterly VAR

## VAR for detrended PCs
Ydet <- Y - df$istar %*% matrix(1, 1, N)
W <- eigen(cov(Ydet))$vectors[,1:3]
P <- Ydet %*% W
ydat <- P[5:T,]
ydat <- sweep(ydat, 2, colMeans(ydat, na.rm=TRUE))
xdat <- P[1:(T-4),]  ## one-year lag -- annual VAR in quarterly observations
xdat <- sweep(xdat, 2, colMeans(xdat, na.rm=TRUE))
B <- t(ydat)%*%xdat%*%solve(t(xdat)%*%xdat)
b <- matrix(NA, 3, N)
B2 <- B
b[,1] <- W[1,] %*% B2
for (i in 2:N) {
    B2 <- B %*% B2
    b[,i] <- W[1,] %*% B2
}
Pbar <- colMeans(P)
Pdem <- sweep(P, 2, Pbar)
Ey_star <- cbind(Y[,1], Pdem %*% b + as.numeric(rep(W[1,] %*% colMeans(P), T) + df$istar))
## print(tail(Ey_star[,1:5]))
## print(apply(Ey_star, 2, sd))

## plot forecasts
plotForecasts <- function() {
    matplot(df$date, Ey_lev, type="l", xaxt="n", xlab="", ylab="Percent", lty=1, main="Expectations, stationary VAR")
    ## matplot(df$date, Ey_lev[,seq(1,15,2)], type="l", xaxt="n", xlab="", ylab="Percent", lty=1, main="Expectations, stationary VAR")
    axis.Date(1, at=seq(as.Date("1980/1/1"), max(df$date), by="10 year"), format = "%Y")
    matplot(df$date, Ey_star, type="l", xaxt="n", xlab="",  ylab="Percent", lty=1, main="Expectations, VAR of detrended yields")
    ## matplot(df$date, Ey_star[,seq(1,15,2)], type="l", xaxt="n", xlab="",  ylab="Percent", lty=1, main="Expectations, VAR of detrended yields")
    axis.Date(1, at=seq(as.Date("1980/1/1"), max(df$date), by="10 year"), format = "%Y")
}
## dev.new()
## par(mfcol=c(2,1), mar=c(3,3,2,1))
## plotForecasts()

tp_lev <- df$y10 - rowMeans(Ey_lev[,1:10])
tp_star <- df$y10 - rowMeans(Ey_star[,1:10])
frn_lev <- rowMeans(Ey_lev[,6:10])
frn_star <- rowMeans(Ey_star[,6:10])
ftp_lev <- df$f510 - frn_lev
ftp_star <- df$f510 - frn_star

## ## plot yield term premium
## dev.new()
## par(mar=c(3,4,2,1))
## plot(df$date, ftp_lev, type="l", col="red", lwd=2, xlab="", ylab="Percent", main="Ten-year term premium")
## lines(df$date, ftp_star, col="steelblue", lwd=2)
## abline(h=0, lty=2)
## legend("topright", c("Stationary VAR", "Trend pi*+r*"), lwd=2, col=c("red", "steelblue"))

## plot decomposition of forward rates
plotFTP <- function(frn, ftp, yrange, flag_legend=TRUE, label="") {
    if (missing(yrange))
        yrange <- range(c(frn, ftp, df$f510))
    plot(df$date, df$f510, type="l", col="black", ylim=yrange, lwd=1, xlab="", ylab="Percent", main=label)
    lines(df$date, frn, col="steelblue", lwd=2)
    lines(df$date, ftp, col="red", lwd=2)
    if (flag_legend)
        legend("topright", c("5-to-10y forward rate", "Expectations", "Forward term premium"), lwd=c(1,2,2), col=c("black", "steelblue", "red"))
}

yrange <- range(c(frn_lev, ftp_lev, frn_star, ftp_star, df$f510))
pdf("figures/ftp_lev_pres.pdf", width=7, height=6, pointsize=10)
plotFTP(frn_lev, ftp_lev, yrange)
dev.off()

pdf("figures/ftp_star_pres.pdf", width=7, height=6, pointsize=10)
plotFTP(frn_star, ftp_star, yrange)
dev.off()

## for paper
pdf("figures/tp.pdf", width=7, height=8, pointsize=10)
par(mfcol=c(2,2), mar=c(3,3,2,1), font.main=1)
plotForecasts()
plotFTP(frn_lev, ftp_lev, yrange, label="Forward term premium, stationary VAR")
plotFTP(frn_star, ftp_star, yrange, flag_legend=FALSE, label="Forward term premium, VAR of detr. yields")
dev.off()

## secular decline in interest rates
df$year <- floor(df$yyyymm/100)
N <- 2
start <- 1980
years <- c(start+(0:N), max(df$year)-(N:0))
yearavg <- function(x) sapply(years, function(y) mean(x[df$year==y]))
tmp <- cbind(years, yearavg(df$f510), yearavg(frn_lev), yearavg(ftp_lev), yearavg(frn_star), yearavg(ftp_star))
colnames(tmp) <- c("Year", "f510", "frn level", "ftp level", "frn star", "ftp star")
## print(round(tmp, 1))
tmp2 <- rbind(colMeans(head(tmp, N+1)), colMeans(tail(tmp, N+1)))
tmp2 <- rbind(tmp2, tmp2[2,]-tmp2[1,])
rownames(tmp2) <- c("1980-1984", "2003-2007", "difference")
print(round(tmp2, 1))

## compare term premia to KW and ACM estimates
kw <- read.csv("data/kimwright.csv")
kw$yyyymm <- kw$YEAR*100+kw$MONTH
kw$kw.ftp <- 2*kw$THREEFYTP1000.B - kw$THREEFYTP0500.B
kw <- kw[c(kw$DATE[-nrow(kw)]>kw$DATE[-1], TRUE), ]
kw$DATE <- NULL
df <- merge(df, kw, all.x=TRUE)

acm <- read.csv("data/acm.csv")
acm$DATE <- as.Date(acm$DATE, format="%d-%b-%Y")
acm$yyyymm <- as.numeric(format(acm$DATE, format="%Y%m"))
acm$DATE <- as.numeric(format(acm$DATE, format="%d"))
acm <- acm[c(acm$DATE[-nrow(acm)]>acm$DATE[-1], TRUE), ]
acm$acm.ftp <- 2*acm$ACMTP10 - acm$ACMTP05
acm$DATE <- NULL
df <- merge(df, acm, all.x=TRUE)

pdf("figures/tp_comparison.pdf", width=7, height=6, pointsize=10)

pdf("figures/tp_comparison_1990.pdf", width=7, height=6, pointsize=10)
ind <- df$yyyymm>199000
cols <- c("red", "steelblue", "green", "black")
plot(df$date[ind], ftp_lev[ind], type="l", ylim=range(df$acm.ftp[ind], ftp_star[ind], ftp_lev[ind]), col=cols[1], lwd=2, xlab="", ylab="Percent")
lines(df$date[ind], ftp_star[ind], col=cols[2], lwd=2)
lines(df$date[ind], df$kw.ftp[ind], col=cols[3], lwd=2)
lines(df$date[ind], df$acm.ftp[ind], col=cols[4], lwd=2)
legend("topright", c("Stationary", "Shifting endpoint", "Kim-Wright", "Adrian-Crump-Moench"), lwd=2, col=cols)
dev.off()


