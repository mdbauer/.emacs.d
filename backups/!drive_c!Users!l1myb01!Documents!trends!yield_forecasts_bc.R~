## compare Blue Chip and statistical forecasts of ten-year Treasury yield
rm(list=ls())
require(xtable) # xtable()
require(forecast)
source("R/trends_fns.R")
graphics.off()

annAvg <- function(x) {
    ## for quarterly forecasts or future yields, calculate annual averages
    stopifnot(length(x)==20)
    vapply(1:5, function(j) mean(x[((j-1)*4+1):(j*4)]), numeric(1))
}

bc <- loadBlueChip()
bc <- bc[bc$year5<=2016,]

df <- loadData()
df[paste0("yhat", 1:5)] <- NA

nms <- c("(1) random walk forecast",
         "(2) Blue Chip",
         "(3) endpoint: pi*_t + const",
         "(4) endpoint: i*_t",
         "(5) AR(1)")

M <- length(nms)
e <- array(NA, c(nrow(bc), 5, M))
rownames(e) <- bc$yyyymm
debugtbl <- matrix(NA, nrow(bc), 5)
rownames(debugtbl) <- bc$yyyymm
for (i in 1:nrow(bc)) {
    t <- max(which(df$yyyymm<bc$yyyymm[i]))
    debugtbl[i,1] <- df$yyyymm[t]

    ## determine forecast horizons
    ## - 20 horizons, from first quarter in year1 to last quarter in year5
    ## - these will be averaged over years
    h1 <- min(which(df$year == bc$year1[i])) - t
    h2 <- h1+20-1
    debugtbl[i,2] <- bc$year1[i]
    debugtbl[i,3] <- bc$year5[i]
    debugtbl[i,4] <- df$yyyymm[t+h1]
    debugtbl[i,5] <- df$yyyymm[t+h2]

    ## future yields
    yfut <- annAvg(df$y10[t+(h1:h2)])

    ## (1) RW
    e[i, ,1] <- yfut - df$y10[t]

    ## (2) Blue Chip
    e[i, ,2] <- yfut - unlist(bc[i, paste0("f", 1:5)])

    ## (3) pi-star + constant
    yhat <- ar1Forecast(df$y10[1:t] - df$pistar.ptr[1:t], h1:h2) + df$pistar.ptr[t]
    e[i, ,3] <- yfut - annAvg(yhat)

    ## (4) i-star
    yhat <- ar1Forecast(df$y10[1:t] - df$istar[1:t], h1:h2, xbar = 0) + df$istar[t]
    df[t, paste0("yhat", 1:5)] <- annAvg(yhat)
    e[i, ,4] <- yfut - annAvg(yhat)

    ## (5) AR(1)
    yhat <- ar1Forecast(df$y10[1:t], h1:h2)
    e[i, ,5] <- yfut - annAvg(yhat)
}
## print(debugtbl)

tbl_rmse <- rbind(apply(e, c(3,2), function(x) sqrt(mean(x^2))), NA, NA)
rownames(tbl_rmse) <- c(nms, "DM (4) vs (1)", "DM (4) vs (2)")
## ... and MAE
tbl_mae <- rbind(apply(e, c(3,2), function(x) mean(abs(x))), NA, NA)
rownames(tbl_mae) <- c(nms, "DM (4) vs (1)", "DM (4) vs (2)")

## Diebold-Mariano
for (j in 1:5) {
    ## (4) vs. (1)
    tbl_rmse[M+1, j] <- myDMtest(e[,j,4], e[,j,1], alternative="less", h=j*4, power=2)$p.value
    tbl_mae[M+1, j] <- myDMtest(e[,j,4], e[,j,1], alternative="less", h=j*4, power=1)$p.value
    ## (4) vs. (2)
    tbl_rmse[M+2, j] <- myDMtest(e[,j,4], e[,j,2], alternative="less", h=j*4, power=2)$p.value
    tbl_mae[M+2, j] <- myDMtest(e[,j,4], e[,j,2], alternative="less", h=j*4, power=1)$p.value
}

cat("RMSE:\n")
print(round(tbl_rmse, 2))

cat("MAE:\n")
print(round(tbl_mae, 2))

cat("Number of quarterly observations:", nrow(bc), "\n")
print(range(bc$yyyymm))

tbl <- tbl_mae
rownames(tbl) <- c("(1) Random walk", "(2) Blue Chip",
                   "(3) Endpoint $\\pi^\\ast_t + \\hat{\\mu}_t$",
                   "(4) Endpoint $\\pi^\\ast_t + r^\\ast_t$",
                   "(5) AR(1)",
                   "DM $p$-value (4) vs.~(1)", "DM $p$-value (4) vs.~(2)")
print(xtable(tbl, digits=2),
      include.rownames=TRUE, include.colnames=FALSE, only.contents=TRUE,
      sanitize.text.function=function(x){x}, hline.after=M,
      file = "tables/yield_forecasts_bc_mae_new.tex")

## fan charts with actual yield and forecast errors
cols <- c("black", "steelblue", "forestgreen")
ind <- df$yyyymm >= 198712
yrange <- range(bc[paste0("f", 1:5)], df$y10[ind])
## 1) Blue Chip
pdf("figures/forecasts_bc.pdf", width=7, height=6, pointsize=10)
plot(df$date[ind], df$y10[ind], ylim=yrange, type="l", xlab="", ylab="Percent", col=cols[1], xaxs = "i", yaxs = "i")
for (i in 1:nrow(bc)) {
    ## plot one line for each Blue Chip forecast
    t <- max(which(df$yyyymm<bc$yyyymm[i])) # which date in df
    dates <- c(df$date[t],
               as.Date(as.character(bc[i,paste0("year", 1:5)]*10000+701), "%Y%m%d"))
    lines(dates, c(df$y10[t], unlist(bc[i, paste0("f", 1:5)])), col=cols[2])
}
legend("topright", c("Ten-year yield", "Blue Chip forecasts"), col=cols, lwd=1)
dev.off()
## 2) i* endpoint
pdf("figures/forecasts_istar.pdf", width=7, height=6, pointsize=10)
plot(df$date[ind], df$y10[ind], ylim=yrange, type="l", xlab="", ylab="Percent", col=cols[1], xaxs = "i", yaxs = "i")
for (i in 1:nrow(bc)) {
    ## plot one line for each istar forecast
    t <- max(which(df$yyyymm<bc$yyyymm[i])) # which date in df
    dates <- c(df$date[t],
               as.Date(as.character(bc[i,paste0("year", 1:5)]*10000+701), "%Y%m%d"))
    lines(dates, c(df$y10[t], unlist(df[t, paste0("yhat", 1:5)])), col=cols[3])
}
legend("topright", c("Ten-year yield", "i* forecasts"), col=cols[c(1,3)], lwd=1)
dev.off()
