rm(list=ls())
graphics.off()

load("results/delnegro_2017-09-06.RData")
M <- nrow(phi)
T <- nrow(df)

## prepare data for plotting
df$rstar <- apply(X[,1,], 2, mean)
df$rstar_u95 <- apply(X[,1,], 2, quantile, 0.975)
df$rstar_l95 <- apply(X[,1,], 2, quantile, 0.025)
df$pistar <- apply(X[,2,], 2, mean)
df$pistar_u95 <- apply(X[,2,], 2, quantile, 0.975)
df$pistar_l95 <- apply(X[,2,], 2, quantile, 0.025)
df$realshort <- df$y1 - df$pi_e
df$exprealshort <- df$y1_e - df$pi_e
df$tpstar <- apply(X[,3,], 2, mean)
df$tpstar_u95 <- apply(X[,3,], 2, quantile, 0.975)
df$tpstar_l95 <- apply(X[,3,], 2, quantile, 0.025)
df$spread <- df$y80 - df$y1

require(ggplot2)
require(cowplot)

## Figure 1 - r-star and pi-star
p1 <- ggplot(data = df, mapping = aes(x = date)) + xlab(NULL) + ylab(NULL) +
    geom_ribbon(aes(ymin = rstar_l95, ymax = rstar_u95), fill="grey70") +
    geom_line(aes(y = rstar), linetype = 5) +
    geom_line(aes(y = realshort), color = "blue", linetype = 3, na.rm=TRUE) +
    geom_point(aes(y = exprealshort), color="blue", na.rm=TRUE) +
    geom_hline(yintercept = 0) +
    ggtitle("r* and (expected) real short rate")
p2 <- ggplot(data = df, mapping = aes(x = date)) + xlab(NULL) + ylab(NULL) +
    geom_ribbon(aes(ymin = pistar_l95, ymax = pistar_u95), fill="grey70") +
    geom_line(aes(y = pistar), linetype = 5) +
    geom_line(aes(y = pi), color = "blue", linetype = 3, na.rm=TRUE) +
    geom_line(aes(y = pi_e), color="blue", na.rm=TRUE) +
    geom_hline(yintercept = 0) +
    ggtitle("pi*, inflation and PTR")
dev.new(width=12, height=5)
plot_grid(p1, p2)

## Figure A1 - term premium
dev.new(width=6, height=5)
ggplot(data = df, mapping = aes(x = date)) + xlab(NULL) + ylab(NULL) +
    geom_ribbon(aes(ymin = tpstar_l95, ymax = tpstar_u95), fill="grey70") +
    geom_line(aes(y = tpstar), linetype = 5) +
    geom_line(aes(y = spread), color = "blue", linetype = 3, na.rm=TRUE) +
    geom_hline(yintercept = 0) +
    ggtitle("term premium trend and term spread")

## Figure A2 - all observables and their trend and cycle components
Lambda <- matrix(0, n, q)
Lambda[3:5,1] <- 1; Lambda[,2] <- 1; Lambda[4,3] <- 1

Xp <- aperm(X, c(2,3,1)) ## make states first dimension
dim(Xp) <- c(q+n, T*M)     ## deform to matrix
Ybar <- Lambda %*% Xp[1:q,]
dim(Ybar) <- c(n, T, M)
Ytilde <- Xp[seq(q+1, q+n),]
dim(Ytilde) <- c(n, T, M)

i <- 2 # choose which series to plot
df$yobs <- Y[,i]
df$ytrend <- apply(Ybar[i,,], 1, mean)
df$ytrend_u95 <- apply(Ybar[i,,], 1, quantile, 0.975)
df$ytrend_l95 <- apply(Ybar[i,,], 1, quantile, 0.025)
df$ycycle <- apply(Ytilde[i,,], 1, mean)
df$ycycle_u95 <- apply(Ytilde[i,,], 1, quantile, 0.975)
df$ycycle_l95 <- apply(Ytilde[i,,], 1, quantile, 0.025)

## data and trend
p1 <- ggplot(data = df, mapping = aes(x = date)) + xlab(NULL) + ylab(NULL) +
    geom_ribbon(aes(ymin = ytrend_l95, ymax = ytrend_u95), fill="grey70") +
    geom_line(aes(y = ytrend), linetype = 5) +
    geom_point(aes(y = yobs), color = "blue", shape = 4, na.rm=TRUE) +
    geom_line(aes(y = yobs), color = "blue", linetype = 1, na.rm=TRUE) +
    geom_hline(yintercept = 0) +
    ggtitle(paste(colnames(Y)[i], "- data and trend"))
## cycle
p2 <- ggplot(data = df, mapping = aes(x = date)) + xlab(NULL) + ylab(NULL) +
    geom_ribbon(aes(ymin = ycycle_l95, ymax = ycycle_u95), fill="grey70") +
    geom_line(aes(y = ycycle), linetype = 5) +
    geom_hline(yintercept = 0) +
    ggtitle(paste(colnames(Y)[i], "- cycle"))
dev.new(width=6, height=8)
plot_grid(p1, p2, ncol = 1)

## MCMC chain
mcmc <- data.frame(sigma_e, sigma_eps, phi)
names(mcmc) <- c(paste("sigma_e", 1:6, sep="_"),
                 paste("sigma_eps", 1:15, sep="_"),
                 paste("phi", 1:(n^2*p), sep="_"))
mcmc$eigenvals <- apply(phi, 1, function(Phivec) {
    Phi <- matrix(Phivec, n*p, n)
    F <- rbind(t(Phi), cbind(diag(n*(p-1)), matrix(0, n*(p-1), n)))
    max(abs(eigen(F)$values)) })

## traceplots
mcmc$id <- as.numeric(rownames(mcmc))
ggplot(mcmc, aes(x=id, y=sigma_e_1)) + geom_line()
ggplot(mcmc, aes(x=id, y=sigma_e_2)) + geom_line()
ggplot(mcmc, aes(x=id, y=sigma_e_3)) + geom_line()
ggplot(mcmc, aes(x=id, y=sigma_eps_1)) + geom_line()
ggplot(mcmc, aes(x=id, y=phi_1)) + geom_line()
ggplot(mcmc, aes(x=id, y=phi_53)) + geom_line()
ggplot(mcmc, aes(x=id, y=eigenvals)) + geom_line() # trace plot of largest eigenvalue of F

## distribution of maximum eigenvalues of VAR
summary(eigenvals)
mean(eigenvals)
ggplot(mcmc, aes(eigenvals)) + geom_histogram(aes(y = ..density..), binwidth=.001)
## highly skewed distribution, very persistent VARs for cycles -- makes sense in light of the figures

## prior and posterior distributions
## for Sigma_e[1,1]

## for Sigma_eps[1,1]

## for Phi[1,1]


## persistence of cycles
Phi <- matrix(apply(phi, 2, median), n*p, n)
F <- rbind(t(Phi), cbind(diag(n*(p-1)), matrix(0, n*(p-1), n)))
print(max(abs(eigen(F)$values)))
## surprising: posterior mean/median Phi is not very persistent, but each individual draw is!


