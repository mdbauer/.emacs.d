## UC model for ex-ante real rate: RW + ARMA(p,q) + noise
rm(list=ls())
graphics.off()
options(error = recover)
source("../pistar/R/uc_fns.R")  # est.uc
source("R/fns.R")
set.seed(616)

df <- loadData()

## estimate UC model
pars <- est.uc(df$earr, p=1, nstarts=10, eps=.0001)
kf <- kalman.uc(pars, df$earr)
df$rstar <- kf$att[1,]

## plot
yrange <- range(c(df$earr, df$rstar, df$rstar.mean))
plot(df$date, df$earr, ylim=yrange, col="black", type="l", lwd=1, xlab="Year", ylab="Annualized Percent")
lines(df$date, df$rstar, col="steelblue", lwd=2)
lines(df$date, getEWMA(df$earr, 0.95), col="green", lwd=2)
legend("topright", c("Ex-ante real rate", "UC trend", "EWMA"), col=c("black", "steelblue", "red", "green"), lwd=c(1,2,2))

## ## model diagnostics
## vt <- as.numeric(kf$vt)
## ft <- as.numeric(kf$Ft)
## mytsdiag(vt, 20)
## Box.test(vt, 20, "Ljung", length(gamma)+1)
## cat("SE =", sd(vt), "\n")
## cat("sqrt(f_T) =", sqrt(tail(ft, 1)), "\n")

