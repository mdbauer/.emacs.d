## forecast yields with pi*+r* vs. random walk vs. unconditional mean

rm(list=ls())
require(xtable) # xtable()
require(forecast)
source("R/trends_fns.r")

forecastTables <-  function() {
    df <- loadData()
    df$istar <- df$pistar.ptr + df$rstar.mean
    T <- nrow(df)
    yieldvars <- c("y5", "y10", "f510")
    N <- length(yieldvars)
    M <- 3 # number of forecast methods
    hmax <- 40 # forecast horizon: 1 quarter to 5 years
    t0 <- 20   # first forecast date
    tbls <- list()
    for (i in seq_along(yieldvars)) {
        yieldvar <- yieldvars[i]
        tbl1 <- matrix(NA, M, hmax)
        tbl2 <- matrix(NA, M, hmax)
        dm.tbl1 <- matrix(NA, 2, hmax)
        dm.tbl2 <- matrix(NA, 2, hmax)
        y <- df[[yieldvar]]
        for (h in 1:hmax) {
            e <- matrix(NA, T-h-t0+1, M)
            for (t in t0:(T-h)) {
                ## RW
                e[t-t0+1, 1] <- y[t+h] - y[t]

                ## pi-star
                s.pistar <- mean(y[1:t] - df$pistar.ptr[1:t])
                rho.pistar <- acf(y[1:t] - df$pistar.ptr[1:t], plot=FALSE)$acf[2]
                e[t-t0+1, 2] <- y[t+h] - (rho.pistar^h*y[t] + (1-rho.pistar^h)*(df$pistar.ptr[t] + s.pistar))

                ## i-star
                rho.istar <- acf(y[1:t] - df$istar[1:t], plot=FALSE)$acf[2]
                e[t-t0+1, 3] <- y[t+h] - (rho.istar^h*y[t] + (1-rho.istar^h)*df$istar[t])
            }
            for (j in 1:M) {
                tbl1[j, h] <- sqrt(mean(e[,j]^2))
                tbl2[j, h] <- mean(abs(e[,j]))
            }
            if ((h==hmax) & yieldvar=="y5") {
                rownames(e) <- df$yyyymm[t0:(T-h)]
                tmp <- cbind(y[(t0+40):T], y[t0:(T-40)], y[(t0+40):T] - y[t0:(T-40)], e[,1,drop=FALSE])
                print(tmp)
            }
            ## (3) vs. (1)
            dm.tbl1[1, h] <- dm.test(e[,3], e[,1], alternative="less", h=h, power=2)$p.value
            dm.tbl2[1, h] <- dm.test(e[,3], e[,1], alternative="less", h=h, power=1)$p.value
            ## (3) vs. (2)
            dm.tbl1[2, h] <- dm.test(e[,3], e[,2], alternative="less", h=h, power=2)$p.value
            dm.tbl2[2, h] <- dm.test(e[,3], e[,2], alternative="less", h=h, power=1)$p.value
        }
        ## tbl[-1,] <- t(t(tbl[-1,]) / tbl[1,])
        rownames(tbl1) <- c("(1) random walk forecast", "(2) pi* + const", "(3) i* = pi* + r*")
        colnames(tbl1) <- 1:hmax
        rownames(dm.tbl1) <- c("DM p-value (3) vs. (1)", "DM p-value (3) vs. (2)")
        rownames(tbl2) <- rownames(tbl1)
        colnames(tbl2) <- colnames(tbl1)
        rownames(dm.tbl2) <- rownames(dm.tbl1)
        tbl1 <- rbind(tbl1, dm.tbl1)
        tbl1 <- tbl1[,c(4,10,20,30,40)]
        tbl2 <- rbind(tbl2, dm.tbl2)
        tbl2 <- tbl2[,c(4,10,20,30,40)]
        ## Latex output - for paper
        tbl <- data.frame(cbind(tbl1, tbl2))
        rownames(tbl) <- c("(1) Random walk", "(2) Endpoint $\\pi^\\ast_t + \\hat{\\mu}_t$",
                           "(3) Endpoint $\\pi^\\ast_t + r^\\ast_t$",
                           "DM $p$-value (3) vs.~(1)", "DM $p$-value (3) vs.~(2)")
        for (row in 1:3)
            tbl[row, ] <- sprintf("%4.2f", tbl[row, ])
        for (row in 4:5)
            tbl[row, ] <- sprintf("(%4.2f)", tbl[row, ])
        tbls[[i]] <- tbl
    }
    setNames(tbls, yieldvars)
}

tbls <- forecastTables()
print(tbls)

## tables for paper
sink("tables/yield_forecasts.tex")
texvarname <- c("Five-year yield", "Ten-year yield", "5-to-10-year forward rate")
for (i in 1:length(tbls)) {
    cat("\\emph{", texvarname[i], "} \\\\ \n", sep="")
    print(xtable(tbls[[i]], digits=2),
          include.rownames=TRUE, include.colnames=FALSE, only.contents=TRUE,
          sanitize.text.function=function(x){x}, hline.after=NULL)
}
sink()

## tables for presentation - 10-year yield
## a) RMSE
print(xtable(tbls[[2]][,1:5], digits=2),
      include.rownames=TRUE, include.colnames=FALSE, only.contents=TRUE,
      sanitize.text.function=function(x){x}, hline.after=NULL,
      file = "tables/yield_forecasts_10y_rmse.tex")
## b) MAE
print(xtable(tbls[[2]][,6:10], digits=2),
      include.rownames=TRUE, include.colnames=FALSE, only.contents=TRUE,
      sanitize.text.function=function(x){x}, hline.after=NULL,
      file = "tables/yield_forecasts_10y_mae.tex")
