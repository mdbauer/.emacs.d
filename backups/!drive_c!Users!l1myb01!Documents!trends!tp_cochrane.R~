## show level/spread dichotomy documented by Cochrane (RSS comment, CP (08))
## contrast with shifting endpoint VAR

rm(list=ls())
graphics.off()
source("R/trends_fns.r")
df <- loadData()
##df <- df[df$yyyymm < 200700,]
df <- df[df$yyyymm < 200800,]
df$istar <- df$pistar.ptr + df$rstar.mean

## yields and PCs
Y <- data.matrix(df[,attr(df, "yield.cols")[3:17]])
T <- nrow(Y)
Ydem <- sweep(Y, 2, colMeans(Y))
rval <- eigen(cov(Ydem))
W <- rval$vectors[,1:3]
P <- Ydem %*% W
N <- 15

## VAR(1) for quarterly observations
## PCs instead of 5 forward rates like Cochrane
## ydat <- P[2:T,]
## xdat <- P[1:(T-1),]
## B <- t(ydat)%*%xdat%*%solve(t(xdat)%*%xdat)
## b <- matrix(NA, 3, N)
## B2 <- B
## for (i in 2:(N*4)) {
##     B2 <- B %*% B2
##     if (i%%4==0)
##         b[,i/4] <- W[1,] %*% B2
## }
## Ey_lev <- cbind(Y[,1], P %*% b + mean(Y[,1]))

## annual VAR similar to Cochrane (he uses monthly observations)
## PCs instead of 5 forward rates like Cochrane
ydat <- P[5:T,]
xdat <- P[1:(T-4),]
B <- t(ydat)%*%xdat%*%solve(t(xdat)%*%xdat)
b <- matrix(NA, 3, N)
B2 <- B
b[,1] <- W[1,] %*% B2
for (i in 2:N) {
    B2 <- B %*% B2
    b[,i] <- W[1,] %*% B2
}
Ey_lev <- cbind(Y[,1], P %*% b + mean(Y[,1]))
## these lead to even more stable long-horizon forecasts than quarterly VAR
print(apply(Ey_lev, 2, sd))

## next: common trend like Cochrane -- VAR for spreads
## instead of 1y yield and 2-5y forward rates I use: 1y yield and 2,5,10y forward rates
F <- cbind(2*Y[,2]-Y[,1], 5*Y[,5]-4*Y[,4], 10*Y[,10]-9*Y[,9])
xdat <- F - Y[,1] %*% matrix(1, 1, ncol(F))
xdat <- xdat[1:(T-4),]
xdat <- sweep(xdat, 2, colMeans(xdat))
ydat <- cbind(Y[5:T,1], F[5:T,]) - Y[1:(T-4),1] %*% matrix(1, 1, ncol(F)+1)
ydat <- sweep(ydat, 2, colMeans(ydat))
Bdiff <- t(ydat)%*%xdat%*%solve(t(xdat)%*%xdat)
B <- cbind(1-rowSums(Bdiff), Bdiff)
B2 <- B
b <- matrix(NA, 1+ncol(F), N)
b[,1] <- B2[1,]
for (i in 2:N) {
    B2 <- B %*% B2
    b[,i] <- B2[1,]
}
X <- cbind(Y[,1], F)
X <- sweep(X, 2, colMeans(X))
Ey_diff <- cbind(Y[,1], X %*% b + mean(Y[,1]))

## what is the trend component?
V <- eigen(B)$vectors
D <- diag(eigen(B)$values)
D[-1, -1] <- 0
Binf <- Re(V %*% D %*% solve(V))
w <- Binf[1,]
#cbind(X %*% w, (X %*% b)[,N])

## now: our trend
X <- cbind(Y[,1], F)
Xdet <- X - df$istar %*% matrix(1, 1, ncol(X))
xdat <- Xdet[1:(T-4),]
## xdat <- sweep(xdat, 2, colMeans(xdat))
## - assume mean zero for y1-i*
##   - also assuming longer rates have mean zero although may want to allow for non-zero mean
ydat <- Xdet[5:T,]
## ydat <- sweep(ydat, 2, colMeans(ydat))
B <- t(ydat)%*%xdat%*%solve(t(xdat)%*%xdat)
B2 <- B
b <- matrix(NA, 1+ncol(X), N)
C <- cbind(1-rowSums(B2), B2)
b[,1] <- C[1,]
for (i in 2:N) {
    B2 <- B %*% B2
    C <- cbind(1-rowSums(B2), B2)
    b[,i] <- C[1,]
}
Z <- cbind(df$istar, cbind(Y[,1], F))
## Z <- sweep(Z, 2, colMeans(Z))
## Ey_star <- cbind(Y[,1], Z %*% b + mean(Y[,1]))
Ey_star <- cbind(Y[,1], Z %*% b)

## plots
dev.new()
par(mfcol=c(3,1), mar=c(3,3,2,1))
matplot(df$date, Ey_lev, type="l", xaxt="n", xlab="", ylab="Percent", lty=1, main="VAR in levels")
axis.Date(1, at=seq(as.Date("1975/1/1"), max(df$date), by="5 year"), format = "%Y")
matplot(df$date, Ey_diff, type="l", xaxt="n", xlab="",  ylab="Percent", lty=1, main="VAR in spreads")
axis.Date(1, at=seq(as.Date("1975/1/1"), max(df$date), by="5 year"), format = "%Y")
matplot(df$date, Ey_star, type="l", xaxt="n", xlab="",  ylab="Percent", lty=1, main="Shifting endpoint/common trend")
axis.Date(1, at=seq(as.Date("1975/1/1"), max(df$date), by="5 year"), format = "%Y")

tp_lev <- df$y10 - rowMeans(Ey_lev[,2:11])
tp_star <- df$y10 - rowMeans(Ey_star[,2:11])
dev.new()
par(mar=c(3,4,2,1))
plot(df$date, tp_lev, type="l", col="red", lwd=2, xlab="", ylab="Percent", main="Ten-year term premium")
lines(df$date, tp_star, col="steelblue", lwd=2)
abline(h=0, lty=2)
legend("topright", c("Stationary VAR", "Trend pi*+r*"), lwd=2, col=c("red", "steelblue"))

## open points:
## - PCs of levels or detrended yields?
