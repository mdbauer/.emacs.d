## replicate AEMS results and assess sensitivity to using different data or definitions of recessions

aems_regs <- function(yields = c("gsw", "fb"), recessions = c("pmi", "nber"), m = 3, nwlag = 3, take_logs = TRUE) {
    library(R.matlab)
    library(sandwich)
    yields <- match.arg(yields)
    recessions <- match.arg(recessions)
    ## Load yields
    filename <- paste0("../AEMS_original/", toupper(yields), ".mat")[[1]]
    data <- readMat("../AEMS_original/FB.mat")[[1]]
    mats <- data[1,-1]
    if (take_logs) {
        Y <- log(1 + data[-1, -1]/100)  # log, annualized yields (not sure why they do that)
    } else {
        Y <- data[-1, -1]/100
    }
    ## Business cycle indicator
    cycle_data <- readMat("../AEMS_original/businessCycle.mat")
    nber <- cycle_data$nber; pmi <- cycle_data$pmi
    nber_dates <- seq(as.Date("1926/1/1"), as.Date("2013/12/1"), by="month")
    pmi_dates <- seq(as.Date("1948/1/1"), as.Date("2016/05/1"), by="month")
    stopifnot(length(pmi)==length(pmi_dates))
    stopifnot(length(nber)==length(nber_dates))
    pmi <- pmi[pmi_dates >= as.Date("1961/6/1") & pmi_dates <= as.Date("2013/12/1")]
    nber <- nber[nber_dates >= as.Date("1961/6/1") & nber_dates <= as.Date("2013/12/1")]
    if (recessions == "pmi") {
        rec <- head(ifelse(pmi<44.5,1,0), -m)
    } else {
        rec <- head(nber, -m)
    }
    regmats <- seq(24,120,24)

    nms <- c("obs", "a", "t(a)", "b", "t(b)", "R^2",
             "a_exp", "t(a_exp)", "b_exp", "t(b_exp)", "a_del", "t(a_del)", "b_del", "t(b_del)", "R^2")
    tbl <- matrix(NA, length(regmats), length(nms))
    colnames(tbl) <- nms
    rownames(tbl) <- regmats

    for (i in seq_along(regmats)) {
        k <- regmats[i]
        xdat1 <- m/(k-m)*head(Y[, mats==k] - Y[,mats==m], -m)
        ydat <- tail(Y[, mats==k-m], -m) - head(Y[, mats==k], -m)
        mod1 <- lm(ydat ~ xdat1)
        se1 <- sqrt(diag(NeweyWest(mod1, lag=nwlag, prewhite=FALSE)))
        t1 <- mod1$coef/se1
        tbl[i, 1:6] <- c(nobs(mod1), 100*mod1$coef[1], t1[1], mod1$coef[2], t1[2], 100*summary(mod1)$r.squared)
        mod2 <- lm(ydat ~ xdat1 + rec + I(xdat1*rec))
        se2 <- sqrt(diag(NeweyWest(mod2, lag=nwlag, prewhite=FALSE)))
        t2 <- mod2$coef/se2
        tbl[i, 7:15] <- c(100*mod2$coef[1], t2[1], mod2$coef[2], t2[2], 100*mod2$coef[3], t2[3], mod2$coef[4], t2[4], 100*summary(mod2)$r.squared)
    }
    tbl <- tbl[,c(1,7:15)]
    print(round(tbl, 2))
}
