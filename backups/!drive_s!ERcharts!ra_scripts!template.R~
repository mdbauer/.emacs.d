#######################################################################################################
# Author: Logan Tribull
# Date: 7/6/2017
# Description:  This file includes all of the code that will produce a standard briefing but without
#               custom charts. Notice the section entitled custom charts. Here is where you should write
#               out the code that produces custom charts. Note if you need guidance look at the corresponding
#               sections in the scripts in ra_scripts.

#######################################################################################################

# note 'standard graphics/prepare_data.R' is a file that both pulls down data from sharepoint
# for standard charts as well as prepares them for plotting i.e. make date column and save as csv
# it will only run on a computer that has been properly networked and or proxyied to allow
# R communication with sharepoint
#######################################################################################################

# dependencies
#######################################################################################################
options(repos=c("http://cran.frb.gov/","http://www.haver.com/r/"))
installed <- installed.packages()[, 1] # list of current installations
dependencies <- c('ggthemes','grid', 'ggplot2','extrafont','readxl', 'reshape2', 'zoo',
                  'Haver')
not_installed <- !(dependencies %in% installed) # what packages aren't installed
to_install <- dependencies[not_installed]
lapply(to_install, install.packages) # installs packages
lapply(dependencies, require, character.only = T)


setwd('S:/ERcharts/')
#######################################################################################################

# helper scripts i.e. themes, colors
#######################################################################################################
source('R/bod_theme.R') # includes all colors, recession dates, margins, sizes, fonts, etc ...
source('R/colors.R') # includes all colors, recession dates, margins, sizes, fonts, etc ...
#######################################################################################################

#######################################################################################################
source('R/gen_ppt.R') # gets standard source books from sharepoint and saves a csv file formatted for compatibility
source('R/bod_plot.R') # function that handles the majority of standard and custom plots
source('R/category_plot.R') # function that handles plots when x axis is a category not date
source('R/clean_raw_data.R')
#######################################################################################################


# 5 standard charts
# here an Ra should only ever have to change the ymin ymax, by_y, and the start date
#######################################################################################################
g_plot <- bod_plot('S:/ERcharts/data/gdp.csv',
                   title = 'Real GDP',
                   subtitle = 'Percent change from 4 quarters earlier',
                   caption = 'Source: Bureau of Economic Analysis and FRBSF staff',
                   dash_name_flag = 'forecast', last_obs_var = 'actual',
                   ymin = -5, ymax = 4, by_y = 1,
                   start = '2009-01-01', end = '2019-12-31', by_date = '1 years',
                   color_prioritization = c(er_dark_blue, er_dark_blue),
                   series_annotations = c('FRBSF\nforecast'), h_lines = 0,
                   series_annotations_y_positions = c(1),
                   series_annotations_x_positions = c('2019-01-31'), num_spaces = 12
)


u_plot <- bod_plot('S:/ERcharts/data/unemployment.csv',
                   title = 'Unemployment rate',
                   subtitle = 'Monthly; seasonally adjusted; forecast is quarterly average',
                   caption = 'Source: Bureau of Economic Analysis and FRBSF staff',
                   dash_name_flag = 'forecast', last_obs_var = 'u',
                   ymin = 0, ymax = 12, by_y = 2,
                   start = '2009-01-01',end = '2019-12-31',
                   color_prioritization = c(er_dark_blue, er_dark_blue),
                   series_annotations = c('FRBSF\nForecast'),
                   series_annotations_y_positions = c(3), date_label_y_offset = .8,
                   series_annotations_x_positions = c('2019-03-30'), last_date_display = 'month',
                   num_spaces = 12, last_obs_has_value = T)


pce_plot <- bod_plot('S:/ERcharts/data/pce.csv',
                     title = 'Personal consumption expenditures price inflation',
                     last_obs_var = 'headline',
                     subtitle = 'Percent change from 4 quarters earlier',
                     caption = 'Source: Bureau of Economic Analysis and FRBSF staff',
                     dash_name_flag = 'forecast',
                     ymin = -2, ymax = 5, by_y = 1,
                     h_lines = 0,
                     start = '2009-01-01', end = '2019-12-31',num_spaces = 12,

                     color_prioritization = c(er_dark_blue, er_red, er_dark_blue, er_red),
                     series_annotations = c('Overall PCE\nprice index',
                                            'Core PCE\nprice index',
                                            '',
                                            'FRBSF\nForecast'),
                     series_annotation_colors = c(er_dark_blue, er_red, 'black', 'black'),
                     series_annotations_y_positions = c(3.5,2.5, 3, 2.5),
                     series_annotations_x_positions = c('2011-01-01',
                                                        '2015-01-31',
                                                        '2015-01-31',
                                                        '2019-01-31'))



interest_plot <- bod_plot('S:/ERcharts/data/interest.csv', is_area = F,
                          last_obs_var = 'two_year',
                          title = 'Interest rates',
                          subtitle = 'Weekly average',
                          caption = 'Source: FAME',
                          ymin = 0, ymax = 7, by_y = 1,
                          start = '2009-01-01',end = '2017-12-31', by_date = '1 year',
                          color_prioritization = c(er_red, er_green, er_dark_blue, er_purple),
                          series_annotations = c('Two-year Treasury',
                                                 'Ten-year Treasury',
                                                 'Federal\nfunds\nrate',
                                                 '30-year mortgage'),
                          series_annotations_y_positions = c(.9,3.2,
                                                             .45, 5), num_spaces = 18,
                          series_annotations_x_positions = c('2013-01-01',
                                                             '2015-01-31',
                                                             '2017-08-15',
                                                             '2014-01-31'), last_date_display = 'date',
                          date_label_x_offset = -100)



payroll_plot <- bod_plot('S:/ERcharts/data/payroll.csv', has_bars = T,
                         bar_colnames = c('change'),
                         title = 'Nonfarm payroll employment',
                         subtitle = 'Monthly change; seasonally adjusted',
                         caption = 'Source: Bureau of Labor Statistics', last_obs_var = 'change',
                         y_lab = 'Thousands', h_lines = 0, date_label_y_offset = 10, date_label_x_offset = -88,
                         ymin = -50, ymax = 400, by_y = 50,
                         start = '2014-01-01', end = '2017-12-31', num_spaces = 40, last_obs_has_value = T,
                         last_obs_value_to_thousands = T,
                         color_prioritization = c(er_dark_blue, er_red, er_dark_blue, er_red),
                         series_annotations = c('6-Month\nmoving\naverage', 'Monthly\nchange'),
                         series_annotations_y_positions = c(275,350), last_date_display = 'month',
                         series_annotations_x_positions = c('2017-01-01', '2015-01-31'))
#######################################################################################################

# custom charts
#######################################################################################################



#######################################################################################################

# Plots are assembled into list and powerpoint is generated
# NOTE: you must add the custom charts you made into the list of plots for them to appear in ppt
#######################################################################################################
file_names <- c('gdp', 'pce', 'unemployment', 'payroll', 'interest')
plots <- list(g_plot, pce_plot, u_plot, payroll_plot, interest_plot)
names(plots) <- file_names

for(name in file_names){
  p <- plots[[name]]
  print(p)
  ggsave(paste('S:/ERcharts/png/', name, '.png',sep = ''), p, width = 9, height = 6,   device = 'png')
}
#######################################################################################################

